<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Balan√ßa Smart - MQTT</title>
  <link rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background-color: #f8f9fa; }
    #peso {
      font-size: 2.5rem;
      font-weight: bold;
      color: #007bff;
      transition: all 0.3s ease;
    }
  </style>
</head>
<body>
  <div class="container text-center mt-5">
    <h1 class="mb-3">üì° Shark - Balan√ßa Smart</h1>
    <div class="card shadow p-4 mb-4">
      <h3 class="mb-3">Peso Atual</h3>
      <h2 id="peso">Conectando ao broker MQTT...</h2>
    </div>

    <div class="card shadow p-4">
      <h4>Hist√≥rico de Leitura</h4>
      <canvas id="graficoPeso" height="100"></canvas>
    </div>
  </div>

  <script>
    // === CONFIGURA√á√ïES DO BROKER ===
    const broker = 'ws://test.mosquitto.org:8080/mqtt';
    const topic = 'shark/balanca/peso';
    const client = mqtt.connect(broker);

    // === ELEMENTOS HTML ===
    const pesoElem = document.getElementById('peso');
    const ctx = document.getElementById('graficoPeso').getContext('2d');

    // === CONFIGURA√á√ÉO DO GR√ÅFICO ===
    const dadosGrafico = {
      labels: [],
      datasets: [{
        label: 'Peso (g ou kg)',
        data: [],
        borderColor: '#007bff',
        tension: 0.2,
      }]
    };

    const grafico = new Chart(ctx, {
      type: 'line',
      data: dadosGrafico,
      options: {
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });

    // === CONEX√ÉO MQTT ===
    client.on('connect', () => {
      console.log("‚úÖ Conectado ao broker MQTT (Mosquitto)");
      pesoElem.innerText = "Aguardando dados...";
      client.subscribe(topic);
    });

    client.on('message', (t, msg) => {
      const peso = msg.toString();
      console.log("üì• Peso recebido:", peso);
      pesoElem.innerText = peso;

      // Anima√ß√£o leve
      pesoElem.style.color = "orange";
      setTimeout(() => pesoElem.style.color = "#007bff", 300);

      // Atualiza gr√°fico
      const hora = new Date().toLocaleTimeString();
      dadosGrafico.labels.push(hora);
      dadosGrafico.datasets[0].data.push(parseFloat(peso.replace(/[^\d.]/g, '')));

      // Mant√©m s√≥ as √∫ltimas 20 leituras
      if (dadosGrafico.labels.length > 20) {
        dadosGrafico.labels.shift();
        dadosGrafico.datasets[0].data.shift();
      }

      grafico.update();
    });

    client.on('error', (err) => {
      console.error("‚ùå Erro MQTT:", err);
      pesoElem.innerText = "Erro ao conectar ao broker MQTT.";
      pesoElem.style.color = "red";
    });
  </script>
</body>
</html>
